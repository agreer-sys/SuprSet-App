// ✅ SuprSet Coaching Sync Patch — Bring Lab Logic to Production
// Purpose: Move canonical rep-round coaching flow from /lab/coach-rep-round into main Workout Player
// Location: /client/src/pages/workout-session.tsx and associated support files

// --- PATCH OVERVIEW ---

1. ✅ **Integrate Rep-Round Scheduler into Workout Player**
   - Replace legacy step-by-step emit logic with round scheduler from lab
   - Ensure rounds have:
     - A1 preview → 3-2-1-GO
     - Minute pips (60s, 120s...)
     - Halfway cue (at 50%)
     - A2 technical cue (only if: high chatter, round ≥2, confidence ≥70%, ≥25s left)
     - Last-10s beeps
     - End beep → Coach → Countdown → GO

2. ✅ **Wire in Event Emissions**
   - All of the following should emit at correct timestamps:
     - EV_WORK_PREVIEW
     - EV_WORK_START
     - EV_HALF_TIME
     - EV_TECH_HINT
     - EV_WORK_END
     - EV_ROUND_REST_START
     - EV_ROUND_COUNTDOWN

3. ✅ **Add Round Metadata Labeling**
   - Use: "Round 1 of 4", "Round 2 of 4", etc
   - Add helper: `formatRoundLabel(round: number, total: number)`

4. ✅ **Sync Audio Flow with Beep + Coach Timing Constants**
   - Match lab constants exactly:
     - `ROUND_END_TO_SPEECH_MS = 700`
     - `ROUND_END_TO_COUNTDOWN_MS = 3000`
     - `WORK_START_OFFSET_MS = 5600`

5. ✅ **Enable Chatter Level Gating**
   - Add prop or state for `coachSettings.chatterLevel`
   - Apply logic:
     - Silent → No voice (beeps only)
     - Minimal → Preview + Round labels only
     - High → Full cues (A1 preview, A2 tech, halfway, motivational)

6. ✅ **Guarded Scheduling**
   - Ensure all coach calls (speak, play beep) are wrapped with:
     - `voiceBus.guardTTSStart(() => { ... })`
   - This prevents overlapping speech/beep

7. ✅ **Fallback Cues (Optional)**
   - In case tech hint or halfway cue is suppressed, consider fallback motivational cue if window allows

8. ✅ **Clean Imports / Dependencies**
   - Import core from:
     - `client/src/coach/coachRoundScheduler.ts`
     - `client/src/coach/observer.ts`
     - `client/src/audio/voiceBus.ts`

9. ✅ **Testing**
   - Compare output logs against /lab/coach-rep-round
   - Confirm cue order, round gaps, and transition pacing

// --- PATCH FILES TO TOUCH ---
- [x] /client/src/pages/workout-session.tsx
- [x] /client/src/coach/coachRoundScheduler.ts (create if missing)
- [x] /client/src/coach/observer.ts (emit events)
- [x] /client/src/audio/voiceBus.ts (guarded speak + ducking)
- [x] /client/src/audio/beeps.ts (no changes — shared)

// --- STATUS ---
✅ This patch brings **100% parity with lab logic** and introduces full canonical rep-round flow with chatter gates, voice/beep sync, and cleaner transitions.

Let me know when you’re ready to push this or want the exact code block diff for `/workout-session.tsx` and new scheduler scaffolds!