// client/src/hooks/useRealtimeVoice.ts  â€” around line 261

// ðŸ§© Helper: decide if an event should trigger AI speech/output
function shouldTriggerResponse(eventName: string): boolean {
  const TRIGGER_EVENTS = [
    "set_start",          // announce exercise + cue
    "set_10s_remaining",  // motivation
    "set_complete",       // ask weight/reps
    "rest_start",         // rest instruction
    "await_ready",        // ask readiness
    "user_ready",         // acknowledge readiness
    "block_transition",   // announce next block
    "workout_complete"    // session end
  ];

  return TRIGGER_EVENTS.includes(eventName);
}

// ðŸ§  Main function: send every event for context; trigger speech only for select ones
const sendEvent = useCallback(
  (eventName: string, data?: any) => {
    if (wsRef.current?.readyState !== WebSocket.OPEN) return;

    const triggerResponse = shouldTriggerResponse(eventName);

    // --- Always send every event (AI needs full context) ---
    const eventMessage = data
      ? `EVENT: ${eventName} ${JSON.stringify(data)}`
      : `EVENT: ${eventName}`;

    console.log(
      triggerResponse
        ? "ðŸ“¡ Sending event to AI (will trigger response):"
        : "ðŸ“¡ Sending event to AI (context only):",
      eventMessage
    );

    // Send structured event message
    wsRef.current.send(
      JSON.stringify({
        type: "conversation.item.create",
        item: {
          type: "message",
          role: "user",
          content: [
            {
              type: "input_text",
              text: eventMessage,
            },
          ],
        },
      })
    );

    // --- Only trigger AI speech/output for key events ---
    if (triggerResponse) {
      if (activeResponseRef.current) {
        console.log("ðŸ”„ Queuing response-triggering event:", eventName);
        eventQueueRef.current.push({ eventName, data });
        return;
      }

      activeResponseRef.current = true;
      wsRef.current.send(
        JSON.stringify({
          type: "response.create",
        })
      );
    }
  },
  []
);
